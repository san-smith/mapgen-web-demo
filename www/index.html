<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MapGen Web Demo</title>
    <meta name="description" content="Procedural world generator in your browser">
    <link rel="stylesheet" href="style.css">
</head>

<body>
    <div class="container">
        <header>
            <h1>üó∫Ô∏è MapGen Web Demo</h1>
            <p>Procedural world generation in your browser using Rust + WASM</p>
        </header>

        <main>
            <div class="status" id="status">
                <div class="status-icon">‚è≥</div>
                <div class="status-text">Loading WASM module...</div>
            </div>

            <button id="test-btn" disabled>Test WASM (greet)</button>
            <button id="generate-btn" disabled>Generate Heightmap</button>

            <div class="canvas-container">
                <canvas id="map-canvas" width="800" height="400"></canvas>
                <div class="canvas-overlay" id="canvas-overlay">
                    <div class="loading-spinner"></div>
                    <div class="loading-text">Generating world...</div>
                </div>
            </div>

            <div class="debug" id="debug"></div>
        </main>

        <footer>
            <p>
                Powered by <a href="https://github.com/san-smith/mapgen" target="_blank">mapgen</a> ‚Ä¢
                <a href="https://github.com/san-smith/mapgen-web-demo" target="_blank">Source Code</a>
            </p>
        </footer>
    </div>

    <script type="module">
        // –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º —Ñ—É–Ω–∫—Ü–∏–∏ –∏–∑ –Ω–∞—à–µ–≥–æ WASM-–º–æ–¥—É–ª—è
        import init, { greet, generate_heightmap_simple } from './mapgen.js';

        // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ (–∞–Ω–∞–ª–æ–≥ _MyAppState –≤ Flutter)
        let canvas, ctx;
        const statusEl = document.getElementById('status');
        const debugEl = document.getElementById('debug');

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
        async function initApp() {
            updateStatus('üü°', 'Initializing WASM module...');

            try {
                // –ó–∞–≥—Ä—É–∂–∞–µ–º –∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º WASM
                await init();

                updateStatus('üü¢', 'WASM module loaded successfully!');
                logDebug('‚úÖ WASM initialized');

                // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –∫–∞–Ω–≤–∞—Å
                canvas = document.getElementById('map-canvas');
                ctx = canvas.getContext('2d');

                // –í–∫–ª—é—á–∞–µ–º –∫–Ω–æ–ø–∫–∏
                document.getElementById('test-btn').disabled = false;
                document.getElementById('generate-btn').disabled = false;

                // –¢–µ—Å—Ç–∏—Ä—É–µ–º —Å–≤—è–∑—å —Å WASM
                const greeting = greet('Browser');
                logDebug(`üí¨ ${greeting}`);

            } catch (error) {
                updateStatus('üî¥', 'Failed to load WASM module');
                logDebug(`‚ùå WASM initialization error: ${error.message}`);
                console.error('WASM init failed:', error);
            }
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞
        function updateStatus(icon, text) {
            statusEl.querySelector('.status-icon').textContent = icon;
            statusEl.querySelector('.status-text').textContent = text;
        }

        // –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ –æ—Ç–ª–∞–¥–æ—á–Ω—É—é –ø–∞–Ω–µ–ª—å
        function logDebug(message) {
            const timestamp = new Date().toLocaleTimeString();
            debugEl.innerHTML += `[${timestamp}] ${message}<br>`;
            debugEl.scrollTop = debugEl.scrollHeight;
        }

        // –¢–µ—Å—Ç–æ–≤–∞—è —Ñ—É–Ω–∫—Ü–∏—è
        document.getElementById('test-btn').addEventListener('click', () => {
            const name = prompt('Enter your name:', 'World');
            const greeting = greet(name || 'World');
            alert(greeting);
            logDebug(`üí¨ Greeting: ${greeting}`);
        });

        // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∫–∞—Ä—Ç—ã –≤—ã—Å–æ—Ç
        document.getElementById('generate-btn').addEventListener('click', async () => {
            const overlay = document.getElementById('canvas-overlay');
            overlay.style.display = 'flex';
            updateStatus('‚è≥', 'Generating heightmap...');
            logDebug('üöÄ Starting heightmap generation...');

            try {
                // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –∫–∞—Ä—Ç—É (—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –¥–ª—è —Ç–µ—Å—Ç–∞)
                const result = await generate_heightmap_simple(42, 800, 400);
                logDebug(`‚úÖ Heightmap generated: ${result.width}x${result.height}`);

                // –†–µ–Ω–¥–µ—Ä–∏–º –Ω–∞ –∫–∞–Ω–≤–∞—Å
                renderHeightmap(result);

                updateStatus('üü¢', 'Heightmap generated successfully!');
            } catch (error) {
                updateStatus('üî¥', 'Generation failed');
                logDebug(`‚ùå Generation error: ${error.message}`);
                console.error('Generation failed:', error);
            } finally {
                overlay.style.display = 'none';
            }
        });

        // –†–µ–Ω–¥–µ—Ä–∏–Ω–≥ –∫–∞—Ä—Ç—ã –≤—ã—Å–æ—Ç –Ω–∞ –∫–∞–Ω–≤–∞—Å
        function renderHeightmap(data) {
            if (!ctx) return;

            // –ü–†–û–í–ï–†–ö–ê: —É–±–µ–¥–∏–º—Å—è, —á—Ç–æ –¥–∞–Ω–Ω—ã–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã
            if (typeof data.width !== 'number' || typeof data.height !== 'number') {
                console.error('Invalid heightmap data:', data);
                alert('–û—à–∏–±–∫–∞: –ø–æ–ª—É—á–µ–Ω—ã –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –∫–∞—Ä—Ç—ã');
                return;
            }

            const imgData = ctx.createImageData(data.width, data.height);
            const pixels = imgData.data;

            // data.data ‚Äî —ç—Ç–æ Float32Array (–Ω–µ –æ–±—ã—á–Ω—ã–π –º–∞—Å—Å–∏–≤!)
            const heightValues = data.data; // Float32Array

            for (let i = 0; i < heightValues.length; i++) {
                const h = heightValues[i]; // –ó–Ω–∞—á–µ–Ω–∏–µ 0.0..1.0
                const idx = i * 4;
                const val = Math.floor(h * 255);
                pixels[idx] = val;     // R
                pixels[idx + 1] = val; // G
                pixels[idx + 2] = val; // B
                pixels[idx + 3] = 255; // A
            }

            ctx.putImageData(imgData, 0, 0);
            logDebug(`üé® Heightmap rendered: ${data.width}x${data.height} (${heightValues.length} pixels)`);
        }

        // –ó–∞–ø—É—Å–∫–∞–µ–º –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—é –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        window.addEventListener('DOMContentLoaded', initApp);
    </script>
</body>

</html>