<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MapGen Web Demo</title>
    <meta name="description" content="Procedural world generator in your browser">
    <link rel="stylesheet" href="style.css">
</head>

<body>
    <div class="container">
        <header>
            <h1>üó∫Ô∏è MapGen Web Demo</h1>
            <p>Procedural world generation in your browser using Rust + WASM</p>
        </header>

        <div class="main-layout">
            <!-- –õ–µ–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞: –∫–∞—Ä—Ç–∞ -->
            <div class="map-area">
                <div class="status" id="status">
                    <div class="status-icon">‚è≥</div>
                    <div class="status-text">Loading WASM module...</div>
                </div>

                <div class="canvas-container">
                    <canvas id="map-canvas"></canvas>
                    <div class="canvas-overlay" id="canvas-overlay">
                        <div class="loading-spinner"></div>
                        <div class="loading-text">Generating world... (may take 10-30 seconds)</div>
                    </div>
                </div>

                <div class="debug" id="debug"></div>
            </div>

            <!-- –ü—Ä–∞–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞: –ø–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è -->
            <div class="control-panel">
                <h2 style="margin-bottom: 20px; color: #667eea;">üéõÔ∏è World Generator</h2>

                <div class="controls">
                    <div class="control-group">
                        <label for="seed-input">
                            <span class="label-text">Seed:</span>
                            <input type="number" id="seed-input" value="42" min="0" max="4294967295">
                        </label>
                    </div>

                    <div class="control-group">
                        <label for="temp-slider">
                            <span class="label-text">Temperature:</span>
                            <input type="range" id="temp-slider" min="-1" max="1" step="0.1" value="0">
                            <span class="value-display" id="temp-value">0.0</span>
                        </label>
                    </div>

                    <div class="control-group">
                        <label for="humid-slider">
                            <span class="label-text">Humidity:</span>
                            <input type="range" id="humid-slider" min="-1" max="1" step="0.1" value="0">
                            <span class="value-display" id="humid-value">0.0</span>
                        </label>
                    </div>

                    <div class="control-group">
                        <label for="width-input">
                            <span class="label-text">Width:</span>
                            <input type="number" id="width-input" value="400" min="256" max="1024" step="64">
                        </label>
                    </div>

                    <div class="control-group">
                        <label for="height-input">
                            <span class="label-text">Height:</span>
                            <input type="number" id="height-input" value="200" min="128" max="512" step="64">
                        </label>
                    </div>

                    <button id="generate-btn" class="primary-btn">Generate World</button>
                    <button id="random-seed-btn" class="secondary-btn">üé≤ Random Seed</button>
                </div>
            </div>
        </div>

        <footer>
            <p>
                Powered by <a href="https://github.com/YOUR_USERNAME/mapgen" target="_blank">mapgen</a> ‚Ä¢
                <a href="https://github.com/YOUR_USERNAME/mapgen-web-demo" target="_blank">Source Code</a>
            </p>
        </footer>
    </div>

    <script type="module">
        // –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º —Ñ—É–Ω–∫—Ü–∏–∏ –∏–∑ –Ω–∞—à–µ–≥–æ WASM-–º–æ–¥—É–ª—è
        import init, {
            greet,
            generate_heightmap_simple,
            generate_world_with_config
        } from './mapgen.js';

        // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
        let canvas, ctx;
        let currentWorldData = null;
        const statusEl = document.getElementById('status');
        const debugEl = document.getElementById('debug');

        function handleResize() {
            const canvas = document.getElementById('map-canvas');
            const container = document.querySelector('.canvas-container');

            // –£–°–¢–ê–ù–ê–í–õ–ò–í–ê–ï–ú –õ–û–ì–ò–ß–ï–°–ö–ò–ï –†–ê–ó–ú–ï–†–´ –ö–ê–ù–í–ê–°–ê –†–ê–í–ù–´–ú–ò –†–ê–ó–ú–ï–†–ê–ú –ö–û–ù–¢–ï–ô–ù–ï–†–ê
            canvas.width = container.clientWidth;
            canvas.height = container.clientHeight;

            // –ü–µ—Ä–µ—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º –∫–∞—Ä—Ç—É —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –æ–Ω–∞ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
            if (currentWorldData) {
                renderHeightmap(currentWorldData);
            }
        }

        window.addEventListener('resize', handleResize);
        handleResize();

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
        async function initApp() {
            updateStatus('üü°', 'Initializing WASM module...');

            try {
                // –ó–∞–≥—Ä—É–∂–∞–µ–º –∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º WASM
                await init();

                updateStatus('üü¢', 'WASM module loaded successfully!');
                logDebug('‚úÖ WASM initialized');

                // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –∫–∞–Ω–≤–∞—Å
                canvas = document.getElementById('map-canvas');
                ctx = canvas.getContext('2d');

                // –¢–µ—Å—Ç–∏—Ä—É–µ–º —Å–≤—è–∑—å —Å WASM
                const greeting = greet('Browser');
                logDebug(`üí¨ ${greeting}`);

            } catch (error) {
                updateStatus('üî¥', 'Failed to load WASM module');
                logDebug(`‚ùå WASM initialization error: ${error.message}`);
                console.error('WASM init failed:', error);
            }
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞
        function updateStatus(icon, text) {
            statusEl.querySelector('.status-icon').textContent = icon;
            statusEl.querySelector('.status-text').textContent = text;
        }

        // –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ –æ—Ç–ª–∞–¥–æ—á–Ω—É—é –ø–∞–Ω–µ–ª—å
        function logDebug(message) {
            const timestamp = new Date().toLocaleTimeString('en-US', {
                hour12: false,
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            });

            const isWarning = message.includes('‚ö†Ô∏è') || message.includes('Error');
            const isError = message.includes('‚ùå') || message.includes('failed');
            const color = isError ? '#dc3545' : isWarning ? '#ffc107' : '#28a745';

            debugEl.innerHTML += `<span style="color: ${color};">[${timestamp}] ${message}</span><br>`;
            debugEl.scrollTop = debugEl.scrollHeight;
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –∑–Ω–∞—á–µ–Ω–∏–π –ø–æ–ª–∑—É–Ω–∫–æ–≤
        document.getElementById('temp-slider').addEventListener('input', (e) => {
            const value = parseFloat(e.target.value);
            document.getElementById('temp-value').textContent = value.toFixed(1);
        });

        document.getElementById('humid-slider').addEventListener('input', (e) => {
            const value = parseFloat(e.target.value);
            document.getElementById('humid-value').textContent = value.toFixed(1);
        });

        // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Å–ª—É—á–∞–π–Ω–æ–≥–æ —Å–∏–¥–∞
        document.getElementById('random-seed-btn').addEventListener('click', () => {
            const randomSeed = Math.floor(Math.random() * 4294967295);
            document.getElementById('seed-input').value = randomSeed;
            logDebug(`üé≤ Random seed: ${randomSeed}`);
        });

        // –û—Å–Ω–æ–≤–Ω–∞—è –∫–Ω–æ–ø–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏
        document.getElementById('generate-btn').addEventListener('click', async () => {
            const overlay = document.getElementById('canvas-overlay');
            overlay.style.display = 'flex';

            try {
                // –°–±–æ—Ä –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ –∏–∑ —Ñ–æ—Ä–º—ã
                const config = {
                    seed: parseInt(document.getElementById('seed-input').value),
                    width: parseInt(document.getElementById('width-input').value),
                    height: parseInt(document.getElementById('height-input').value),
                    globalTemperatureOffset: parseFloat(document.getElementById('temp-slider').value),
                    globalHumidityOffset: parseFloat(document.getElementById('humid-slider').value),
                };

                // –í–∞–ª–∏–¥–∞—Ü–∏—è
                if (isNaN(config.seed) || config.seed < 0 || config.seed > 4294967295) {
                    throw new Error('Invalid seed value (must be 0-4294967295)');
                }
                if (config.width < 256 || config.width > 1024) {
                    throw new Error('Width must be between 256 and 1024');
                }
                if (config.height < 128 || config.height > 512) {
                    throw new Error('Height must be between 128 and 512');
                }

                logDebug(`üöÄ Generating world with config:`);
                logDebug(`   Seed: ${config.seed}`);
                logDebug(`   Size: ${config.width}x${config.height}`);
                logDebug(`   Temperature: ${config.globalTemperatureOffset}`);
                logDebug(`   Humidity: ${config.globalHumidityOffset}`);

                updateStatus('‚è≥', 'Generating world...');

                // –í—ã–∑–æ–≤ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Å –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–µ–π
                const result = await generate_world_with_config(config);

                logDebug(`‚úÖ World generated: ${result.width}x${result.height}`);
                currentWorldData = result;

                // –†–µ–Ω–¥–µ—Ä–∏–Ω–≥
                renderHeightmap(result);

                updateStatus('üü¢', `World generated successfully! Seed: ${config.seed}`);

            } catch (error) {
                updateStatus('üî¥', 'Generation failed');
                logDebug(`‚ùå Error: ${error.message}`);
                console.error('Generation failed:', error);
                alert(`Generation failed: ${error.message}`);
            } finally {
                overlay.style.display = 'none';
            }
        });

        // –†–µ–Ω–¥–µ—Ä–∏–Ω–≥ –∫–∞—Ä—Ç—ã –≤—ã—Å–æ—Ç –Ω–∞ –∫–∞–Ω–≤–∞—Å
        function renderHeightmap(data) {
            if (!ctx) return;

            // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç–∏ –¥–∞–Ω–Ω—ã—Ö
            if (typeof data.width !== 'number' || typeof data.height !== 'number') {
                console.error('Invalid heightmap ', data);
                alert('Error: received invalid map data');
                return;
            }

            // –°–æ–∑–¥–∞—ë–º –≤—Ä–µ–º–µ–Ω–Ω–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å —Ä–∞–∑–º–µ—Ä–∞–º–∏ data.width x data.height
            const tempCanvas = document.createElement('canvas');
            const tempCtx = tempCanvas.getContext('2d');
            tempCanvas.width = data.width;
            tempCanvas.height = data.height;

            // –†–∏—Å—É–µ–º –∫–∞—Ä—Ç—É –Ω–∞ –≤—Ä–µ–º–µ–Ω–Ω–æ–º –∫–∞–Ω–≤–∞—Å–µ
            const tempImgData = tempCtx.createImageData(data.width, data.height);
            const pixels = tempImgData.data;

            const heightValues = data.data;
            for (let i = 0; i < heightValues.length; i++) {
                const h = heightValues[i];
                const idx = i * 4;
                const val = Math.floor(h * 255);
                pixels[idx] = val;     // R
                pixels[idx + 1] = val; // G
                pixels[idx + 2] = val; // B
                pixels[idx + 3] = 255; // A
            }
            tempCtx.putImageData(tempImgData, 0, 0);

            // –ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–π –∫–∞–Ω–≤–∞—Å –Ω–∞ –æ—Å–Ω–æ–≤–Ω–æ–π –∫–∞–Ω–≤–∞—Å
            const scale = Math.min(
                ctx.canvas.width / data.width,
                ctx.canvas.height / data.height
            );

            const scaledWidth = data.width * scale;
            const scaledHeight = data.height * scale;
            const x = (ctx.canvas.width - scaledWidth) / 2;
            const y = (ctx.canvas.height - scaledHeight) / 2;

            ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);
            ctx.drawImage(
                tempCanvas,
                0, 0, data.width, data.height,
                x, y, scaledWidth, scaledHeight
            );

            logDebug(`üé® Heightmap rendered: ${data.width}x${data.height} ‚Üí ${scaledWidth}x${scaledHeight} (scale: ${scale.toFixed(2)})`);
        }

        // –ó–∞–ø—É—Å–∫–∞–µ–º –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—é –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        window.addEventListener('DOMContentLoaded', initApp);
    </script>
</body>

</html>